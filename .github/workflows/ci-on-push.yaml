name: NVRC E2E
on:
  pull_request_target:
    branches:
      - 'main'
    types:
      # Adding 'labeled' to the list of activity types that trigger this event
      # (default: opened, synchronize, reopened) so that we can run this
      # workflow when the 'ok-to-test' label is added.
      # Reference: https://docs.github.com/en/actions/using-workflows/events-that-trigger-workflows#pull_request_target
      - opened
      - synchronize
      - reopened
      - labeled

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Detect if only docs changed - skip CI if so
  # Only run if ok-to-test label present (security gate for self-hosted runner)
  changes:
    name: Detect changes
    if: ${{ contains(github.event.pull_request.labels.*.name, 'ok-to-test') }}
    runs-on: ubuntu-latest
    outputs:
      code: ${{ steps.filter.outputs.code }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          # For pull_request_target, checkout the PR head to detect changes
          ref: ${{ github.event.pull_request.head.sha }}
          # Fetch enough history to compare with base
          fetch-depth: 0
      - uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        id: filter
        with:
          # For pull_request_target, explicitly specify base and ref
          base: ${{ github.event.pull_request.base.sha }}
          ref: ${{ github.event.pull_request.head.sha }}
          filters: |
            code:
              - '**/*.rs'
              - '**/*.toml'
              - '**/*.lock'
              - 'Cargo.lock'
              - '.cargo/**'

  ci:
    needs: changes
    # Only run on self-hosted runner if: 1) ok-to-test label present (security), 2) code changed (efficiency)
    if: ${{ contains(github.event.pull_request.labels.*.name, 'ok-to-test') && needs.changes.outputs.code == 'true' }}
    permissions:
      contents: read
      packages: write
      id-token: write
      attestations: write
    uses: ./.github/workflows/ci.yaml
    with:
      commit-hash: ${{ github.event.pull_request.head.sha }}
      pr-number: ${{ github.event.pull_request.number }}
      tag: ${{ github.event.pull_request.number }}-${{ github.event.pull_request.head.sha }}
      target-branch: ${{ github.event.pull_request.base.ref }}

  # Gate job for branch protection - set "CI Complete" as required status check
  # Passes when: CI succeeded OR no code changes (docs-only PR)
  ci-complete:
    name: CI Complete
    needs: [changes, ci]
    if: always() && contains(github.event.pull_request.labels.*.name, 'ok-to-test')
    runs-on: ubuntu-latest
    steps:
      - name: Check CI result
        run: |
          if [[ "${{ needs.changes.outputs.code }}" != "true" ]]; then
            echo "✓ No code changes - CI skipped"
            exit 0
          fi
          if [[ "${{ needs.ci.result }}" == "success" ]]; then
            echo "✓ CI passed"
            exit 0
          fi
          echo "✗ CI failed: ${{ needs.ci.result }}"
          exit 1
